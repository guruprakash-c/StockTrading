<!DOCTYPE html>
<html>

<head>
    <title>Ichimoku Cloud Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>

<body>
    <div style="width: 80%; margin: auto;">
        <canvas id="ichimokuChart"></canvas>
    </div>

    <script>
        async function fetchIchimokuData() {
            try {
                const response = await fetch('Ichimoku.php');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                renderChart(data);
            } catch (error) {
                console.error('Error fetching Ichimoku data:', error);
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('ichimokuChart').getContext('2d');

            // Adjust the fill colors dynamically based on Senkou Span A and B
            const aIndex = data.datasets.findIndex(d => d.label === 'Span A');
            const bIndex = data.datasets.findIndex(d => d.label === 'Span B');

            const aData = data.datasets[aIndex].data;
            const bData = data.datasets[bIndex].data;

            let cloudColors = 'rgba(0, 0, 0, 1)';
            if (aData) {
                cloudColors = aData.map((a, i) => {
                    if (a !== null && bData[i] !== null) {
                        return a > bData[i] ? 'rgba(0, 255, 0, 0.2)' : 'rgba(255, 0, 0, 0.2)';
                    }
                    return 'rgba(0, 0, 0, 1)';
                });
            }

            data.datasets[aIndex].backgroundColor = cloudColors;

            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Ichimoku Cloud Chart' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        },
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: { display: true, text: 'Date' }
                        },
                        y: {
                            title: { display: true, text: 'Price' }
                        }
                    },
                    datasets: {
                        line: {
                            // Ensure the fill option is enabled for Senkou Span A and B
                            fill: false,
                            tension: 0,
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    },
                }
            });
        }

        fetchIchimokuData();
    </script>
</body>

</html>